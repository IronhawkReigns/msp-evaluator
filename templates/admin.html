<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f5f7;
      padding: 2rem;
    }
    .card {
      background-color: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      max-width: 800px;
      margin: auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    a.logout {
      font-size: 0.9rem;
      color: #999;
      text-decoration: none;
    }
    a.logout:hover {
      color: #000;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>MSP ë²¡í„° DB ê´€ë¦¬</h1>
      <a href="/logout" class="logout">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <p>ì•ˆë…•í•˜ì„¸ìš”, <strong>{{ user.name }}</strong>ë‹˜ ğŸ‘‹</p>
    <p>ì´ í˜ì´ì§€ì—ì„œ íŒŒíŠ¸ë„ˆì‚¬ì˜ ë²¡í„° ë°ì´í„°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <ul style="margin-top: 2rem; padding-left: 1.2rem;">
      <li><a href="/ui">ë²¡í„° DB ë·°ì–´ ì—´ê¸°</a></li>
      <li><a href="/run/SampleMSP">ìƒ˜í”Œ MSP ë²¡í„° ìƒì„± ì‹¤í–‰</a></li>
      <li><a href="/ui/delete_company/SampleMSP">ìƒ˜í”Œ MSP ì‚­ì œ ì‹¤í–‰</a></li>
    </ul>

    <hr style="margin: 2rem 0;">

    <h2>íŒŒíŠ¸ë„ˆì‚¬ ì‚­ì œ</h2>
    <p>ë²¡í„° DBì—ì„œ ì‚­ì œí•  íšŒì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>

    <select id="company-select" style="margin-top: 1rem; padding: 0.5rem; width: 100%;">
      <option value="" disabled selected>íšŒì‚¬ ì„ íƒ</option>
    </select>

    <button onclick="deleteCompany()" style="margin-top: 1rem; padding: 0.5rem 1rem; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
      ì„ íƒí•œ íšŒì‚¬ ì‚­ì œ
    </button>

    <p id="result-message" style="margin-top: 1rem; color: green;"></p>

    <hr style="margin: 2rem 0;">

    <h2>íŒŒíŠ¸ë„ˆì‚¬ ë²¡í„° ì¬ìƒì„±</h2>
    <p>ì„ íƒí•œ íšŒì‚¬ì˜ ë²¡í„°ë¥¼ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤:</p>

    <button onclick="rebuildVector()" style="margin-top: 1rem; padding: 0.5rem 1rem; background-color: #03c75a; color: white; border: none; border-radius: 4px; cursor: pointer;">
      ì„ íƒí•œ íšŒì‚¬ ë²¡í„° ì¬ìƒì„±
    </button>

    <p id="rebuild-message" style="margin-top: 1rem; color: blue;"></p>

    <hr style="margin: 2rem 0;">
    <h2>ìµœê·¼ ë²¡í„° ìƒì„± ì‹œê°„</h2>
    <ul id="log-list" style="padding-left: 1.2rem;"></ul>

    <script>
      async function fetchCompanies() {
        try {
          const res = await fetch("/ui/data");
          const data = await res.json();
          const select = document.getElementById("company-select");
          Object.keys(data).forEach(name => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          });
        } catch (e) {
          console.error("íšŒì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
        }
      }

      async function deleteCompany() {
        const name = document.getElementById("company-select").value;
        if (!name) return;
        try {
          const res = await fetch(`/ui/delete_company/${name}`, {
            method: "DELETE"
          });
          const result = await res.json();
          document.getElementById("result-message").textContent = `${name} ì‚­ì œë¨ (ì´ ${result.count}ê°œ í•­ëª©)`;
        } catch (e) {
          document.getElementById("result-meYesssage").textContent = "ì‚­ì œ ì‹¤íŒ¨";
          console.error("ì‚­ì œ ì—ëŸ¬:", e);
        }
      }

      async function rebuildVector() {
        const name = document.getElementById("company-select").value;
        if (!name) return;
        try {
          const res = await fetch(`/run/${name}`);
          if (res.ok) {
            document.getElementById("rebuild-message").textContent = `${name} ë²¡í„° ì¬ìƒì„± ì™„ë£Œ`;
          } else {
            throw new Error();
          }
        } catch (e) {
          document.getElementById("rebuild-message").textContent = "ë²¡í„° ì¬ìƒì„± ì‹¤íŒ¨";
          console.error("ì¬ìƒì„± ì—ëŸ¬:", e);
        }
      }

      async function showTimestamps() {
        try {
          const res = await fetch("/ui/data");
          const data = await res.json();
          const logList = document.getElementById("log-list");
          logList.innerHTML = "";
          for (const name in data) {
            const li = document.createElement("li");
            const timestamp = data[name].last_updated || "ì •ë³´ ì—†ìŒ";
            if(timestamp === "ì •ë³´ ì—†ìŒ") {
              li.textContent = `${name} â†’ ë§ˆì§€ë§‰ ë²¡í„° ìƒì„±: ${timestamp}`;
            } else {
              const date = new Date(timestamp);
              const formatted = date.toLocaleString("ko-KR", {
                timeZone: "Asia/Seoul",
                year: "numeric", month: "2-digit", day: "2-digit",
                hour: "2-digit", minute: "2-digit"
              });
              li.textContent = `${name} â†’ ë§ˆì§€ë§‰ ë²¡í„° ìƒì„±: ${formatted}`;
            }
            logList.appendChild(li);
          }
        } catch (e) {
          console.error("ë²¡í„° ìƒì„± ì‹œê°„ ë¡œë”© ì‹¤íŒ¨:", e);
        }
      }

      fetchCompanies();
      showTimestamps();
    </script>
  </div>
</body>
</html>
