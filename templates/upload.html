<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ì—‘ì…€ ì—…ë¡œë“œ í‰ê°€</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        label, input, button { font-size: 1rem; margin: 0.5em 0; }
    </style>
</head>
<body>
    <h2>ğŸ“¤ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ í›„ í‰ê°€</h2>
    <form id="uploadForm">
        <label for="excelFile">ì—‘ì…€ íŒŒì¼ (.xlsx):</label><br>
        <input type="file" id="excelFile" name="file" accept=".xlsx" required><br>
        <button type="submit">ì—…ë¡œë“œ ë° í‰ê°€</button>
    </form>
    <div id="result"></div>
    <div id="summaryTable" style="margin-top: 2em;"></div>
    <button id="uploadToVectorDbBtn" style="margin-top: 2em;">ğŸ“¤ ë²¡í„° DBì— ì—…ë¡œë“œ</button>

    <script>
        const form = document.getElementById('uploadForm');
        let result = {};
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('summaryTable').innerHTML = '';
            const fileInput = document.getElementById('excelFile');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const res = await fetch('/api/upload_excel', {
                method: 'POST',
                body: formData
            });

            result = await res.json();
            const output = document.getElementById('result');
            // Render evaluated_questions as a formatted table if present
            if (result.evaluated_questions && Array.isArray(result.evaluated_questions)) {
                const evalTable = document.createElement('table');
                evalTable.style.borderCollapse = 'collapse';
                evalTable.style.marginTop = '2em';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Category', 'Question', 'Answer', 'Score'].forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    th.style.border = '1px solid black';
                    th.style.padding = '0.5em';
                    th.style.background = '#eaf7ff';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                evalTable.appendChild(thead);

                const tbody = document.createElement('tbody');
                result.evaluated_questions.forEach(q => {
                    const tr = document.createElement('tr');
                    [q.category || '', q.question || '', q.answer || '', q.score !== undefined ? q.score : ''].forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.style.border = '1px solid black';
                        td.style.padding = '0.5em';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                evalTable.appendChild(tbody);
                document.getElementById('summaryTable').appendChild(evalTable);
            } else {
                output.innerHTML = '<h3>âœ… í‰ê°€ ê²°ê³¼ ìš”ì•½</h3><pre>' + JSON.stringify(result, null, 2) + '</pre>';
            }

            if (result.summary && Array.isArray(result.summary)) {
                const table = document.createElement('table');
                table.style.borderCollapse = 'collapse';
                table.style.marginTop = '1em';

                const headers = ['Category', 'Score', 'Questions'];
                const thead = document.createElement('thead');
                const headRow = document.createElement('tr');
                headers.forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    th.style.border = '1px solid black';
                    th.style.padding = '0.5em';
                    th.style.background = '#f0f0f0';
                    headRow.appendChild(th);
                });
                thead.appendChild(headRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                result.summary.forEach(row => {
                    const tr = document.createElement('tr');
                    let cells = [];

                    if (Array.isArray(row)) {
                        cells = row;
                    } else if (typeof row === 'object') {
                        cells = [row.Category || '', row.Score || '', row.Questions || ''];
                    }

                    cells.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.style.border = '1px solid black';
                        td.style.padding = '0.5em';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                document.getElementById('summaryTable').appendChild(table);
            }


            if (result.evaluations && Array.isArray(result.evaluations)) {
                const detailedOutput = document.createElement('div');
                detailedOutput.innerHTML = '<h3>ğŸ“‹ ì§ˆë¬¸ë³„ í‰ê°€ ì ìˆ˜</h3>';

                const table = document.createElement('table');
                table.style.borderCollapse = 'collapse';
                table.style.marginTop = '1em';

                const headers = ['Category', 'Question', 'Score'];
                const thead = document.createElement('thead');
                const headRow = document.createElement('tr');
                headers.forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    th.style.border = '1px solid black';
                    th.style.padding = '0.5em';
                    th.style.background = '#f9f9f9';
                    headRow.appendChild(th);
                });
                thead.appendChild(headRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                result.evaluations.forEach(row => {
                    const tr = document.createElement('tr');
                    const cells = [
                        row.category || '',
                        row.question || '',
                        row.score !== undefined ? row.score : ''
                    ];
                    cells.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.style.border = '1px solid black';
                        td.style.padding = '0.5em';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                detailedOutput.appendChild(table);
                document.getElementById('summaryTable').appendChild(detailedOutput);
            }
        });

        const vectorUploadBtn = document.getElementById('uploadToVectorDbBtn');
        vectorUploadBtn.addEventListener('click', async () => {
            const mspName = prompt("ì—…ë¡œë“œí•  MSP ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!mspName) {
                alert("MSP ì´ë¦„ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const items = [];
            if (result.evaluated_questions && Array.isArray(result.evaluated_questions)) {
                result.evaluated_questions.forEach(q => {
                    items.push({
                        question: q.question,
                        answer: q.answer,
                        score: q.score
                    });
                });
            }

            const response = await fetch('/api/add_to_vector_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    msp_name: mspName, 
                    items: items,
                    summary: result.summary
                })
            });

            if (response.ok) {
                alert("âœ… ë²¡í„° DBì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨");
            }
        });
    </script>
</body>
</html>
