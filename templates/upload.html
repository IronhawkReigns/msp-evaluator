<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>MSP 평가 업로드 및 결과</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo@1.0/nanumsquareneo.css" />
<style>
  body {
    font-family: 'NanumSquareNeo', sans-serif !important;
    background: linear-gradient(135deg, #e8fef3 0%, #f0fbf6 100%);
    color: #1e1e1e;
    margin: 40px;
  }
  h1, h2 {
    color: #03c75a;
    font-weight: 900;
    text-align: center;
    margin-bottom: 32px;
  }
  form {
    max-width: 680px;
    margin: 0 auto 40px auto;
  }
  label {
    font-weight: 600;
    font-size: 14px;
    color: #666;
    display: block;
    margin-bottom: 6px;
  }
  input[type="file"] {
    display: block;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #d0d7de;
    font-size: 15px;
    box-sizing: border-box;
  }
  button {
    display: block;
    width: 100%;
    padding: 16px;
    background: linear-gradient(90deg, #03c75a, #1ecb8f);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(3, 199, 90, 0.2);
    transition: filter 0.2s ease;
    font-family: 'NanumSquareNeo', sans-serif;
  }
  button:hover {
    filter: brightness(1.08);
  }

  table {
    width: 100%;
    max-width: 680px;
    margin: 0 auto 40px auto;
    border-collapse: collapse;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    font-size: 14px;
  }
  th, td {
    padding: 10px 12px;
    border: 1px solid #ddd;
    vertical-align: middle;
  }
  th {
    background-color: #03c75a;
    color: white;
    font-weight: 700;
    text-align: center;
  }
  td:first-child {
    font-weight: 700;
  }
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  /* Buttons for copying category scores */
  #copy-buttons {
    max-width: 680px;
    margin: 0 auto 40px auto;
    text-align: center;
  }
  #copy-buttons button {
    font-size: 14px;
    padding: 10px 20px;
    margin: 0 10px 10px 10px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-family: 'NanumSquareNeo', sans-serif;
    transition: background 0.3s ease;
  }
  #copy-buttons button:nth-child(1) {
    background-color: #03c75a;
    color: white;
  }
  #copy-buttons button:nth-child(1):hover {
    background-color: #029c45;
  }
  #copy-buttons button:nth-child(2) {
    background-color: #1ecb8f;
    color: white;
  }
  #copy-buttons button:nth-child(2):hover {
    background-color: #169a69;
  }
  #copy-buttons button:nth-child(3) {
    background-color: #56d4b8;
    color: white;
  }
  #copy-buttons button:nth-child(3):hover {
    background-color: #3ea88a;
  }
</style>
</head>
<body>
  <a class="header-title" href="https://mspevaluator.duckdns.org" target="_blank" rel="noopener noreferrer"
     style="position: fixed; top: 20px; left: 30px; font-size: 20px; font-weight: 700; color: #03c75a; font-family: 'Noto Sans KR', sans-serif; text-decoration: none;">
    NAVER Cloud
  </a>
  <a href="/logout"
     style="position: fixed; top: 20px; right: 30px; font-size: 14px; font-weight: 600; color: #666; font-family: 'Noto Sans KR', sans-serif; text-decoration: none;">
    로그아웃
  </a>

  <h1>📤 엑셀 파일 업로드 및 평가</h1>
  <form id="uploadForm">
    <label for="excelFile">엑셀 파일 (.xlsx):</label>
    <input type="file" id="excelFile" name="file" accept=".xlsx" required />
    <button type="submit">업로드 및 평가</button>
  </form>

  <div id="summaryTable"></div>
  <div id="copy-buttons" style="display:none;">
    <button id="copy-personnel">인적 역량 점수 복사</button>
    <button id="copy-ai-tech">AI 기술 역량 점수 복사</button>
    <button id="copy-solution">솔루션 역량 점수 복사</button>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    let result = {};

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('summaryTable').innerHTML = '';
      document.getElementById('copy-buttons').style.display = 'none';

      const fileInput = document.getElementById('excelFile');
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const res = await fetch('/api/upload_excel', { method: 'POST', body: formData });
      result = await res.json();

      renderSummaryTable(result.summary);

      if (result.summary && Array.isArray(result.summary)) {
        document.getElementById('copy-buttons').style.display = 'block';
      }
    });

    function renderSummaryTable(summary) {
      if (!summary || !Array.isArray(summary)) return;
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['Category', 'Score', 'Questions'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      summary.forEach(row => {
        const tr = document.createElement('tr');
        let cells = [];
        if (Array.isArray(row)) {
          cells = row;
        } else if (typeof row === 'object') {
          cells = [row.Category || '', row.Score || '', row.Questions || ''];
        }
        cells.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      const summaryDiv = document.getElementById('summaryTable');
      summaryDiv.innerHTML = '';
      summaryDiv.appendChild(table);
    }

    // Copy scores vertically by category name
    function copyCategoryScores(categoryName) {
      if (!result.summary || !Array.isArray(result.summary)) return;
      let lines = [];
      result.summary.forEach(row => {
        const cat = Array.isArray(row) ? row[0] : (row.Category || '');
        const score = Array.isArray(row) ? row[1] : (row.Score || '');
        if (cat === categoryName) {
          lines.push(score);
        }
      });
      if (lines.length === 0) {
        alert(categoryName + ' 데이터가 없습니다.');
        return;
      }
      const textToCopy = lines.join('\n');
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert(categoryName + ' 점수가 복사되었습니다.');
      }).catch(() => {
        alert('복사에 실패했습니다.');
      });
    }

    document.getElementById('copy-personnel').addEventListener('click', () => copyCategoryScores('인적역량'));
    document.getElementById('copy-ai-tech').addEventListener('click', () => copyCategoryScores('AI기술역량'));
    document.getElementById('copy-solution').addEventListener('click', () => copyCategoryScores('솔루션 역량'));
  </script>
</body>
</html>
