<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partner Capability Assessment Tool - NAVER Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      font-feature-settings: 'cv11', 'ss01';
      font-variation-settings: 'opsz' 32;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #d1fae5 100%);
      color: #1f2937;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Enhanced Background Decoration */
    .background-decoration {
      position: fixed;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }

    .floating-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      animation: float 8s ease-in-out infinite;
    }

    .orb-1 {
      top: -10%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: linear-gradient(135deg, rgba(5, 150, 105, 0.15), rgba(13, 148, 136, 0.15));
      animation-delay: 0s;
    }

    .orb-2 {
      bottom: -10%;
      left: -10%;
      width: 350px;
      height: 350px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.15));
      animation-delay: 2s;
    }

    .orb-3 {
      top: 33%;
      left: 25%;
      width: 250px;
      height: 250px;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1));
      animation-delay: 4s;
    }

    .grid-pattern {
      position: absolute;
      inset: 0;
      background-image: 
        linear-gradient(rgba(5, 150, 105, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(5, 150, 105, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(40px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInDown {
      0% { opacity: 0; transform: translateY(-30px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes gradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Glass Morphism */
    .glass-morphism {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    /* Gradient Text */
    .gradient-text {
      background: linear-gradient(135deg, #059669 0%, #0d9488 50%, #14b8a6 100%);
      background-size: 300% 300%;
      animation: gradient 8s ease infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .gradient-border {
      background: linear-gradient(45deg, #059669, #0d9488, #14b8a6, #06b6d4);
      background-size: 300% 300%;
      animation: gradient 6s ease infinite;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(5, 150, 105, 0.1);
      padding: 1rem 2rem;
      animation: fadeInDown 0.6s ease-out;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-container {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #059669, #0d9488);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .logo-icon {
      width: 24px;
      height: 24px;
      color: white;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 900;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .header-title:hover {
      text-decoration: none;
      transform: scale(1.05);
    }

    .admin-link {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, #059669, #0d9488);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .admin-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
    }

    /* Main Container */
    .main-container {
      position: relative;
      z-index: 10;
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Hero Section */
    .hero-section {
      text-align: center;
      margin-bottom: 4rem;
      animation: fadeInUp 0.8s ease-out;
    }

    .upload-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 2rem;
      padding: 1rem 2rem;
      background: rgba(5, 150, 105, 0.1);
      border-radius: 9999px;
      border: 1px solid rgba(5, 150, 105, 0.2);
      font-weight: 700;
      color: #059669;
    }

    .upload-badge-icon {
      width: 24px;
      height: 24px;
    }

    .upload-badge-dot {
      width: 8px;
      height: 8px;
      background: #059669;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .hero-title {
      font-size: 3.5rem;
      font-weight: 900;
      margin-bottom: 1.5rem;
      color: #1f2937;
      line-height: 1.1;
      letter-spacing: -0.025em;
    }

    .hero-subtitle {
      font-size: 1.25rem;
      color: #6b7280;
      font-weight: 500;
      max-width: 700px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Upload Form */
    .upload-form-container {
      margin-bottom: 3rem;
      animation: fadeInUp 0.8s ease-out;
      animation-delay: 0.2s;
    }

    .upload-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 2.5rem;
      border-radius: 32px;
      position: relative;
      overflow: hidden;
    }

    .upload-form::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #059669, #0d9488, #14b8a6);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-label {
      font-size: 1rem;
      font-weight: 700;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .file-input-wrapper {
      position: relative;
    }

    .file-input-border {
      padding: 2px;
      border-radius: 16px;
      background: linear-gradient(45deg, #059669, #0d9488, #14b8a6, #06b6d4);
      background-size: 300% 300%;
      animation: gradient 6s ease infinite;
    }

    .file-input {
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 14px;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
      margin: 0;
    }

    .file-input:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .upload-button {
      padding: 1.25rem 2rem;
      font-size: 1.125rem;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #059669 0%, #0d9488 25%, #14b8a6 50%, #06b6d4 75%, #0ea5e9 100%);
      background-size: 300% 300%;
      animation: gradient 4s ease infinite;
      color: white;
      box-shadow: 0 8px 24px rgba(5, 150, 105, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .upload-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .upload-button:hover::before {
      left: 100%;
    }

    .upload-button:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 32px rgba(5, 150, 105, 0.4);
    }

    .upload-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Tables */
    .table-container {
      margin-bottom: 3rem;
      border-radius: 24px;
      overflow: hidden;
      animation: fadeInUp 0.8s ease-out;
    }

    .table-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #059669, #0d9488, #14b8a6);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    thead tr {
      background: linear-gradient(135deg, #059669, #0d9488);
      color: white;
      font-weight: 700;
      font-size: 1rem;
    }

    th, td {
      padding: 1rem 1.25rem;
      border-right: 1px solid rgba(5, 150, 105, 0.1);
      border-bottom: 1px solid rgba(5, 150, 105, 0.1);
      font-size: 0.9rem;
      white-space: normal;
      word-break: keep-all;
    }

    thead th:first-child,
    tbody td:first-child {
      white-space: nowrap;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th:last-child, td:last-child {
      border-right: none;
    }

    thead th {
      text-align: center;
    }

    tbody td {
      text-align: left;
    }

    thead th:first-child,
    tbody td:first-child {
      text-align: center;
      font-weight: 700;
    }

    tbody tr:hover {
      background-color: rgba(5, 150, 105, 0.05);
    }

    tbody tr:nth-child(even) {
      background-color: rgba(248, 250, 252, 0.8);
    }

    .score-input {
      width: 3.2em;
      font-size: 1rem;
      padding: 0.5em 0.6em;
      border: 2px solid rgba(5, 150, 105, 0.3);
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      font-weight: 600;
    }

    .score-input:focus {
      border-color: #059669;
      outline: none;
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
      animation: fadeInUp 0.8s ease-out;
    }

    .action-btn {
      padding: 0.875rem 1.75rem;
      font-size: 0.95rem;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .action-btn:hover::before {
      left: 100%;
    }

    .action-btn:hover {
      transform: translateY(-2px) scale(1.05);
    }

    .btn-green {
      background: linear-gradient(135deg, #059669, #0d9488);
      color: white;
    }

    .btn-blue {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }

    .btn-orange {
      background: linear-gradient(135deg, #ea580c, #dc2626);
      color: white;
    }

    .btn-primary {
      background: linear-gradient(135deg, #059669 0%, #0d9488 25%, #14b8a6 50%, #06b6d4 75%, #0ea5e9 100%);
      background-size: 300% 300%;
      animation: gradient 4s ease infinite;
      color: white;
    }

    /* Loading Spinner */
    .spinner {
      border: 4px solid rgba(5, 150, 105, 0.1);
      border-top: 4px solid #059669;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }

    /* Chart Section */
    .chart-section {
      margin-top: 3rem;
      text-align: center;
      animation: fadeInUp 0.8s ease-out;
      animation-delay: 0.4s;
    }

    .chart-title {
      font-size: 1.5rem;
      color: #059669;
      font-weight: 900;
      margin-bottom: 2rem;
    }

    .charts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
    }

    .chart-wrapper {
      width: 500px;
      max-width: 100%;
      text-align: center;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .chart-wrapper h4 {
      margin-bottom: 1rem;
      color: #059669;
      font-weight: 700;
      font-size: 1.125rem;
    }

    canvas {
      width: 500px !important;
      height: 500px !important;
      max-width: 100%;
      background-color: transparent;
      display: block;
      margin: 0 auto;
    }

    .download-btn {
      display: block;
      margin: 1rem auto 0;
      padding: 0.5rem 1rem;
      background: #059669;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .download-btn:hover {
      background: #047857;
      transform: translateY(-1px);
    }

    /* Summary Section */
    .summary-section {
      margin-top: 2rem;
      animation: fadeInUp 0.8s ease-out;
      animation-delay: 0.6s;
    }

    .summary-title {
      font-size: 1.25rem;
      color: #059669;
      font-weight: 900;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(5, 150, 105, 0.2);
    }

    .summary-text {
      margin-top: 0.5rem;
      line-height: 1.6;
      color: #374151;
      background: rgba(255, 255, 255, 0.6);
      padding: 1rem;
      border-radius: 12px;
      border-left: 4px solid #059669;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
      .form-group {
        flex-direction: row;
        align-items: center;
      }
      
      .form-label {
        flex: 0 0 200px;
        margin-bottom: 0;
      }
      
      .file-input-wrapper {
        flex: 1;
      }
      
      .upload-button {
        flex: 0 0 200px;
      }
      
      .hero-title {
        font-size: 4rem;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
      }
      
      .header-content {
        padding: 0 1rem;
      }
      
      .hero-title {
        font-size: 2.5rem;
      }
      
      .upload-form {
        padding: 1.5rem;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      
      .chart-wrapper {
        width: 100%;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Background Decoration -->
  <div class="background-decoration">
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="grid-pattern"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-brand">
        <div class="logo-container">
          <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
        </div>
        <a href="/en" class="header-title gradient-text">NAVER Cloud</a>
      </div>
      <a href="/en/login?next=/en/admin" class="admin-link">Admin</a>
    </div>
  </header>

  <div class="main-container">
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="upload-badge">
        <svg class="upload-badge-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <span>Partner Capability Assessment System</span>
        <div class="upload-badge-dot"></div>
      </div>
      
      <h1 class="hero-title gradient-text">Partner Capability Assessment Tool</h1>
      <p class="hero-subtitle">
        <span class="font-semibold gradient-text">Efficiently assess MSP partners</span> with our<br />
        Excel-based automated evaluation and scoring system
      </p>
    </div>

    <!-- Upload Form -->
    <div class="upload-form-container">
      <form id="uploadForm" class="upload-form glass-card" autocomplete="off" novalidate>
        <div class="form-group">
          <label for="excelFile" class="form-label">Excel File (.xlsx)</label>
          <div class="file-input-wrapper">
            <div class="file-input-border">
              <input type="file" id="excelFile" name="file" accept=".xlsx" required class="file-input" />
            </div>
          </div>
          <button type="submit" class="upload-button">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span>Upload & Evaluate</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Results Tables -->
    <div id="evaluatedQuestionsTable"></div>
    <div id="summaryTable"></div>

    <!-- Radar Chart Section -->
    <div id="radarChartSection" class="chart-section" style="display: none;">
      <h3 class="chart-title">Capability Group Radar Charts</h3>
      <div id="radarChartsContainer" class="charts-container"></div>
    </div>

    <!-- Vector DB Upload Button -->
    <div style="text-align:center; margin-top: 24px;">
      <button id="uploadToVectorDbBtn" class="action-btn btn-primary" style="display:none;">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
        </svg>
        Upload to Vector DB
      </button>
    </div>

    <!-- Subcategory Summaries -->
    <div id="subCategorySummaries" class="summary-section"></div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // PRESERVE ALL ORIGINAL JAVASCRIPT FUNCTIONALITY
    const form = document.getElementById('uploadForm');
    const evaluatedQuestionsTable = document.getElementById('evaluatedQuestionsTable');
    const summaryTable = document.getElementById('summaryTable');
    const vectorUploadBtn = document.getElementById('uploadToVectorDbBtn');
    let result = {};

    function createTable(headers, rows, editableScore = false) {
      const tableContainer = document.createElement('div');
      tableContainer.className = 'table-container glass-card';
      tableContainer.style.position = 'relative';
      
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          const key = header.toLowerCase();
          const camelCaseKey = key.replace(/\s+(.)/g, (match, group1) => group1.toUpperCase());

          if (editableScore && camelCaseKey === 'score') {
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'score-input';
            input.min = 1;
            input.max = 5;
            input.value = row[camelCaseKey] !== undefined ? row[camelCaseKey] : '';
            input.addEventListener('change', () => {
              row[camelCaseKey] = Number(input.value);
            });
            td.appendChild(input);
          } else {
            td.textContent = row[camelCaseKey] !== undefined ? row[camelCaseKey] : '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      return tableContainer;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log("DEBUG: Upload started");

      evaluatedQuestionsTable.innerHTML = '<div class="spinner"></div>';
      summaryTable.innerHTML = '';

      // Remove previous subcategory summary container if any
      const oldSubCatContainer = document.getElementById('subCategorySummaries');
      if (oldSubCatContainer) oldSubCatContainer.innerHTML = '';

      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) {
        alert('Please select an Excel file.');
        evaluatedQuestionsTable.innerHTML = '';
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        console.log("DEBUG: Sending upload request...");
        const res = await fetch('/api/upload_excel', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          console.error(`DEBUG: Server responded with error: ${res.status}`);
          throw new Error(`Server error: ${res.status}`);
        }

        result = await res.json();
        // Parse group_to_category_map if needed
        if (typeof result.group_to_category_map === 'string') {
          try {
            result.group_to_category_map = JSON.parse(result.group_to_category_map);
          } catch (e) {
            console.error("❌ Failed to parse group_to_category_map:", e);
          }
        }
        console.log("DEBUG: API result", result);
        
        // === Insert debug logs for summary and groups ===
        console.log("🔍 Summary data from API:", result.summary);
        console.log("🔍 Group data from API:", result.groups);
        
        // Normalize summary structure from backend to frontend format
        if (Array.isArray(result.summary)) {
          result.summary = result.summary.map((item) => ({
            name: item.Category,
            score: item.Score,
            questions: item.Questions,
          }));
        }
        
        // ========== DEBUG LOGS for subcategory_summaries ==========
        console.log("DEBUG: Subcategory summaries keys:", Object.keys(result.subcategory_summaries || {}));
        Object.entries(result.subcategory_summaries || {}).forEach(([group, subcats]) => {
          console.log(`DEBUG: Group '${group}' subcategories:`, Object.keys(subcats));
        });

        if (vectorUploadBtn) {
          vectorUploadBtn.style.display = (result.evaluated_questions && result.evaluated_questions.length) ? 'inline-block' : 'none';
        }

        if (result.evaluated_questions && Array.isArray(result.evaluated_questions)) {
          const evalTable = createTable(['Category', 'Question', 'Answer', 'Score'], result.evaluated_questions, true);
          evaluatedQuestionsTable.innerHTML = '';

          // Copy buttons container
          const copyBtnWrapper = document.createElement('div');
          copyBtnWrapper.className = 'action-buttons';

          // Categories for which to add copy buttons
          const categoriesToCopy = ['Human Resources', 'AI Technical Capabilities', 'Solution Capabilities'];

          categoriesToCopy.forEach(category => {
            const btn = document.createElement('button');
            btn.textContent = `Copy ${category} Scores`;
            btn.className = 'action-btn';

            // Set distinct gradient backgrounds
            switch(category) {
              case 'Human Resources':
                btn.classList.add('btn-green');
                break;
              case 'AI Technical Capabilities':
                btn.classList.add('btn-blue');
                break;
              case 'Solution Capabilities':
                btn.classList.add('btn-orange');
                break;
            }

            btn.addEventListener('click', () => {
              const scoresToCopy = result.evaluated_questions
                .filter(q => q.category === category)
                .map(q => (q.score !== undefined ? q.score : ''))
                .join('\n');
              navigator.clipboard.writeText(scoresToCopy).then(() => {
                alert(`✅ ${category} scores copied to clipboard.`);
              }).catch(() => {
                alert(`❌ Failed to copy ${category} scores.`);
              });
            });

            copyBtnWrapper.appendChild(btn);
          });

          evaluatedQuestionsTable.appendChild(evalTable);
          evaluatedQuestionsTable.appendChild(copyBtnWrapper);
          createOrShowRequestSummaryBtn();
          if (requestSummaryBtn) requestSummaryBtn.style.display = 'inline-block';

        } else {
          evaluatedQuestionsTable.innerHTML = '';
          if (vectorUploadBtn) vectorUploadBtn.style.display = 'none';
        }

        if (result.summary && Array.isArray(result.summary)) {
          const tableContainer = document.createElement('div');
          tableContainer.className = 'table-container glass-card';
          tableContainer.style.position = 'relative';
          
          const table = document.createElement('table');
          table.classList.add('summary-table');

          const headers = ['Category', 'Score', 'Questions'];
          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          headers.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          
          result.summary.forEach((row, index) => {
            const tr = document.createElement('tr');
            
            // Use normalized keys: name, score, questions
            const cells = [row.name || '', row.score || '', row.questions || ''];
            cells.forEach(cell => {
              const td = document.createElement('td');
              td.textContent = cell;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
            
            // Hard coded separator lines after specific rows
            const rowName = row.name || '';
            if (rowName === '솔루션 역량' || 
                rowName === 'AI 윤리 및 책임 의식' || 
                rowName === 'AI 기술의 특허 및 인증 보유 현황') {
              const separatorRow = document.createElement('tr');
              separatorRow.innerHTML = '<td colspan="3" style="border-top: 3px solid #1f2937; padding: 0; background: transparent; height: 2px;"></td>';
              tbody.appendChild(separatorRow);
            }
          });
          
          table.appendChild(tbody);
          tableContainer.appendChild(table);
          summaryTable.innerHTML = '';
          summaryTable.appendChild(tableContainer);
        } else {
          summaryTable.innerHTML = '';
        }

        // === Prepare radar chart labels and scores using groupSummary from API ===
        if (result.groups && Array.isArray(result.groups)) {
          const radarSection = document.getElementById('radarChartSection');
          if (radarSection) {
            radarSection.style.display = 'block';
          }
          const groupSummary = result.groups;
          console.log("🔍 Group data from API:", groupSummary);

          const radarLabels = groupSummary.map((item) => item.name);
          const radarScores = groupSummary.map((item) => item.score);
          console.log("✅ Radar Labels:", radarLabels);
          console.log("✅ Radar Scores:", radarScores);

          // Safety check for group_to_category_map before drawing radar charts
          if (!result.group_to_category) {
            console.warn("group_to_category is missing from API result.");
            result.group_to_category = {};  // fallback to empty object
          }
          
          // Add try-catch to prevent errors from breaking the upload
          try {
            console.log("✅ group_to_category_map:", result.group_to_category);
            drawMultipleRadarCharts(result.groups, result.group_to_category);
          } catch (chartError) {
            console.error("Error drawing radar charts:", chartError);
            // Continue with the rest of the upload process even if charts fail
          }
        }
        
        const subCatSummariesDiv = document.getElementById('subCategorySummaries');
        if (subCatSummariesDiv) subCatSummariesDiv.innerHTML = '';

      } catch (error) {
        console.error("DEBUG: Upload error:", error);
        evaluatedQuestionsTable.innerHTML = '';
        summaryTable.innerHTML = '';
        alert('An error occurred during upload. Please try again.');
        console.error(error);
      }
    });

    // --- Separate Request Summary button logic ---
    let requestSummaryBtn = null;
    function createOrShowRequestSummaryBtn() {
      if (!requestSummaryBtn) {
        requestSummaryBtn = document.createElement('button');
        requestSummaryBtn.id = 'requestSummaryBtn';
        requestSummaryBtn.textContent = 'Request Summary';
        requestSummaryBtn.className = 'action-btn btn-primary';
        requestSummaryBtn.style.display = 'none'; // initially hidden

        // Wrap in centered div
        const btnWrapper = document.createElement('div');
        btnWrapper.id = 'summaryRequestWrapper';
        btnWrapper.style.textAlign = 'center';
        btnWrapper.style.marginTop = '24px';
        btnWrapper.appendChild(requestSummaryBtn);

        summaryTable.parentNode.insertBefore(btnWrapper, summaryTable.nextSibling);

        requestSummaryBtn.addEventListener('click', async () => {
          try {
            requestSummaryBtn.disabled = true;
            requestSummaryBtn.textContent = 'Generating Summary...';

            const response = await fetch('/api/get_summary', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ evaluated: result.evaluated_questions })
            });

            if (!response.ok) throw new Error('Summary request failed');

            const summaryResult = await response.json();
            // ========== DEBUG LOGS for Request Summary subcategory_summaries ==========
            console.log("DEBUG: Request Summary result subcategory_summaries:", summaryResult.subcategory_summaries);
            Object.entries(summaryResult.subcategory_summaries || {}).forEach(([group, subcats]) => {
              console.log(`DEBUG: Request Summary group '${group}' subcategories:`, Object.keys(subcats));
            });

            // Remove or clear previous subcategory summaries container
            const subCategoryContainerId = 'subCategorySummaries';
            let subCatContainer = document.getElementById(subCategoryContainerId);
            if (!subCatContainer) {
              subCatContainer = document.createElement('div');
              subCatContainer.id = subCategoryContainerId;
              subCatContainer.className = 'summary-section';
              summaryTable.parentNode.insertBefore(subCatContainer, btnWrapper.nextSibling);
            } else {
              subCatContainer.innerHTML = '';
            }

            // Render subcategory summaries as flat readable text under group headers
            Object.entries(summaryResult.subcategory_summaries || {}).forEach(([groupName, summaryData]) => {
              const title = document.createElement('h3');
              title.textContent = groupName;
              title.className = 'summary-title';
              subCatContainer.appendChild(title);

              if (typeof summaryData === 'string') {
                const p = document.createElement('p');
                p.textContent = summaryData;
                p.className = 'summary-text';
                subCatContainer.appendChild(p);
              } else if (typeof summaryData === 'object') {
                Object.entries(summaryData).forEach(([subkey, summaryText]) => {
                  const p = document.createElement('p');
                  p.textContent = summaryText;
                  p.className = 'summary-text';
                  subCatContainer.appendChild(p);
                });
              }
            });

            requestSummaryBtn.textContent = 'Request Summary';
            requestSummaryBtn.disabled = false;
          } catch (error) {
            alert('Error occurred during summary request');
            requestSummaryBtn.textContent = 'Request Summary';
            requestSummaryBtn.disabled = false;
            console.error(error);
          }
        });
      }
    }

    // --- Vector DB Upload button handler ---
    const vectorUploadBtnScript = (() => {
      if (vectorUploadBtn) {
        vectorUploadBtn.addEventListener('click', async () => {
          const mspName = prompt("Enter MSP name to upload:");
          if (!mspName) {
            alert("MSP name was not entered.");
            return;
          }

          const items = [];
          if (result.evaluated_questions && Array.isArray(result.evaluated_questions)) {
            result.evaluated_questions.forEach(q => {
              items.push({
                question: q.question,
                answer: q.answer,
                score: q.score
              });
            });
          }

          const response = await fetch('/api/add_to_vector_db', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              msp_name: mspName,
              items: items,
              summary: result.summary
            })
          });

          if (response.ok) {
            alert("✅ Successfully uploaded to Vector DB.");
          } else {
            alert("❌ Upload failed");
          }
        });
      }
    })();

    function drawMultipleRadarCharts(groups, groupToCategoryMap) {
      console.log("📊 drawMultipleRadarCharts called with:");
      console.log("  - groups:", JSON.stringify(groups, null, 2));
      console.log("  - groupToCategoryMap:", JSON.stringify(groupToCategoryMap, null, 2));

      const container = document.getElementById("radarChartsContainer");
      if (!container) {
        console.error("Radar charts container not found");
        return;
      }
      container.innerHTML = ""; // Clear existing charts
      
      // Safety check
      if (!groups || !Array.isArray(groups) || groups.length === 0) {
        console.warn("No groups data for radar charts");
        return;
      }
      
      // Group by parent category
      const categorizedGroups = {
        "Human Resources": [],
        "AI Technical Capabilities": [],
        "Solution Capabilities": []
      };
      
      groups.forEach(group => {
        if (group.name === "Human Resources" || group.name === "AI Technical Capabilities" || group.name === "Solution Capabilities") {
          return;
        }

        const category = groupToCategoryMap[group.name] || "Other";
        if (categorizedGroups[category]) {
          categorizedGroups[category].push(group);
        }
      });

      console.log("📊 Categorized groups:", JSON.stringify(categorizedGroups, null, 2));
      
      // Create a radar chart for each category
      Object.entries(categorizedGroups).forEach(([category, categoryGroups]) => {
        if (categoryGroups.length === 0) return;
        
        // Create wrapper for this category
        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-wrapper';
        
        const canvas = document.createElement('canvas');
        canvas.id = `radar-${category.replace(/\s/g, '-')}`;
        canvas.width = 500;
        canvas.height = 500;
        
        const title = document.createElement('h4');
        title.textContent = category;
        
        chartWrapper.appendChild(title);
        chartWrapper.appendChild(canvas);
        container.appendChild(chartWrapper);

        // Prepare data for Chart.js
        const labels = categoryGroups.map(g => g.name);
        const data = categoryGroups.map(g => g.score);
        
        // Create radar chart
        new Chart(canvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: labels,
            datasets: [{
              label: category,
              data: data,
              backgroundColor: getColorForCategory(category, 0.2),
              borderColor: getColorForCategory(category, 1),
              pointBackgroundColor: getColorForCategory(category, 1),
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: getColorForCategory(category, 1),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: {
              padding: {
                top: 40,
                right: 40,
                bottom: 40,
                left: 40
              }
            },
            scales: {
              r: {
                min: 0,
                max: 100,
                ticks: {
                  stepSize: 20,
                  display: false  // This completely hides the tick labels
                },
                pointLabels: {
                  font: {
                    size: 10,
                    family: 'Inter'
                  },
                  padding: 10  // Add padding to prevent label cutoff
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.r.toFixed(1) + '%';
                  }
                }
              }
            }
          }
        });

        // Add download button
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = 'Download';
        downloadBtn.className = 'download-btn';

        downloadBtn.addEventListener('click', function() {
          // Create a temporary canvas with white background
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = canvas.width;
          tempCanvas.height = canvas.height;
          const tempCtx = tempCanvas.getContext('2d');
          
          // Fill white background
          tempCtx.fillStyle = 'white';
          tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
          
          // Draw the chart canvas on top
          tempCtx.drawImage(canvas, 0, 0);
          
          // Download
          const link = document.createElement('a');
          link.download = `${category}_radar_chart.png`;
          link.href = tempCanvas.toDataURL();
          link.click();
        });

        chartWrapper.appendChild(downloadBtn);
      });
    }

    function getColorForCategory(category, alpha) {
      const colors = {
        "Human Resources": `rgba(5, 150, 105, ${alpha})`,     // Green
        "AI Technical Capabilities": `rgba(14, 165, 233, ${alpha})`,  // Blue
        "Solution Capabilities": `rgba(234, 88, 12, ${alpha})`   // Orange
      };
      return colors[category] || `rgba(128, 128, 128, ${alpha})`;
    }
  </script>
</body>
</html>
